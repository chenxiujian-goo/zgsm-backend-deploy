# .github/workflows/export-code.yml
name: Export Project Code

on:
  # ä»…ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼Œæ”¯æŒé€‰æ‹©åˆ†æ”¯
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦å¯¼å‡ºçš„åˆ†æ”¯åç§°'
        required: true
        default: 'main'
        type: string

jobs:
  export-code:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨è¾“å…¥çš„åˆ†æ”¯
          ref: ${{ github.event.inputs.branch }}
          # èŽ·å–å®Œæ•´åŽ†å²è®°å½•ï¼ˆå¯é€‰ï¼‰
          fetch-depth: 0
      
      - name: Create code archive
        run: |
          # åˆ›å»ºå¯¼å‡ºç›®å½•
          mkdir -p exported-code
          
          # å¤åˆ¶æ‰€æœ‰ä»£ç æ–‡ä»¶ï¼ˆæŽ’é™¤ .git å’Œ node_modules ç­‰ï¼‰
          rsync -av \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='.github' \
            --exclude='*.log' \
            --exclude='.env' \
            --exclude='dist' \
            --exclude='build' \
            --exclude='.next' \
            --exclude='coverage' \
            . exported-code/
          
          # åˆ›å»ºåŽ‹ç¼©åŒ…
          zip -r project-code-export.zip exported-code/
          
          # æ·»åŠ å…ƒæ•°æ®ä¿¡æ¯
          echo "Export Date: $(date)" > export-info.txt
          echo "Commit: ${{ github.sha }}" >> export-info.txt
          echo "Branch: ${{ github.event.inputs.branch }}" >> export-info.txt
          echo "Repository: ${{ github.repository }}" >> export-info.txt
          echo "Triggered by: ${{ github.actor }}" >> export-info.txt
      
      - name: Upload code artifact
        uses: actions/upload-artifact@v4
        with:
          name: project-code-export-${{ github.event.inputs.branch }}-${{ github.run_number }}
          path: |
            project-code-export.zip
            export-info.txt
          # ä¿ç•™ 7 å¤©ï¼ˆGitHub æœ€å¤§æ”¯æŒ 90 å¤©ï¼‰
          retention-days: 7
          compression-level: 9  # æœ€å¤§åŽ‹ç¼©
      
      - name: Summary
        run: |
          echo "## ðŸ“¦ ä»£ç å¯¼å‡ºå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æ–‡ä»¶å**: project-code-export-${{ github.event.inputs.branch }}-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å¯¼å‡ºåˆ†æ”¯**: ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¿ç•™æœŸé™**: 7 å¤©" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
